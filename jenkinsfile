pipeline {
    agent any

    stages {
        
                stage('git') {
		    steps {

			git branch: 'marwen', url: 'https://github.com/Mohamedazizgh/DevOpsSpring.git'
			   }
		   }
        stage ('Cleaning the project'){
		steps {
			sh 'mvn clean'
		}
	}
       stage('MVN Package'){
            steps {
               sh """
	        docker start mysql
	       mvn package  
	       """
            }
        }
        
        
        
        
        stage ('Mockito/Junit') {
             steps {
            sh '''
	    mvn test -Dtest="SecteurActiviteTest" 
	    docker stop mysql
	    '''
            }
        }
        
          stage("Sonar") {
        steps {

       sh '''mvn sonar:sonar
       docker stop sonar '''
       
  
  
               }
     }
       
     stage('Nexus'){
            steps{
                sh """
		docker start nexus
		sleep 240
		mvn deploy """
		
            }
        } 
        
        stage("Docker Image") {
        steps{
           sh ' docker build -t snoussi22/achat-1.0:latest .'
        }
        } 
	stage("login to docker hub") {
        steps{
	
	       sh 'docker login -u snoussi22 -p 50585480Ss '
            
	    
        }
        }
	
	stage("Push to DockerHub") {
                steps{
                    sh 'docker push  snoussi22/achat-1.0:latest'
                }
        }
        
        stage('DockerCompose') {
              steps {
                  sh "docker-compose  up -d  "
              }
              }
              
             
              
          stage('mailling'){
           steps {
            mail bcc: '', body: '''Hello from Jenkins,
            Devops Pipeline returned success.
            Best Regards''', cc: '', from: 'marwensnoussi77@gmail.com', replyTo: '', subject: 'Devops Pipeline', to: 'marwen.snoussi@esprit.tn'
    
            }
       }
        
  
            
        
                
            

    }
    
    post {
      	always {
      		sh 'docker logout'
      		emailext attachLog: true, body: "${env.BUILD_URL} has result ${currentBuild.result}", compressLog: true, subject: "Status of pipeline: ${currentBuild.fullDisplayName}", to: 'marwen.snoussi@esprit.tn'
          	emailext body: 'A Test EMail', recipientProviders: [[$class: 'DevelopersRecipientProvider'], [$class: 'RequesterRecipientProvider']], subject: 'Test'
  		
      	}
      }
}
